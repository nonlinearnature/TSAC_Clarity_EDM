---
title: "Phase 1: Univariate Analysis of BGC"
output: html_notebook
---

This analysis can help us distinguish hypotheses about underlying mechanisms in the lake (ala Hsieh et al. 2005). It also serves as a foundation for subsequent causal and quasi-mechanistic modeling in two ways. (1) It provides guidance on parameters for the analysis, like degree of time averaging. In this case, we are entertaining 2 month and 3 month temporal averaging of the core BGC variables. (2) It validates the grounding assumption of CCM analysis, which is that there are low-dimensional attractor dynamics that (at least partially) explain changes in the time series variables.

## Data Setup

We first set packages.

```{r}
library(rEDM)
library(tidyverse)

sessionInfo()
```

Then load in data created in "Phase 0" from "_0_data_wrangling.Rmd"

```{r}
# load("./DATA/PROCESSED/_0 2-month BGC.Rdata")
load("./DATA/PROCESSED/_0 3-month BGC.Rdata")

df_BGC <- df_3mo_BGC_LTP[68:215,]
```

## EDM Analysis Setup


We will replicate the analysis across several variables, using a few tests and statistics to contextualize and interpret the results.

Null Hypothesis 1: Signal is due to random chance.
Null Hypothesis 2: Signal is due to serial autocorrelation in the time series.
Null Hypothesis 3: Signal is due to seasonal cycling.


### Univariate Analysis

```{r}
do_univariate_1_var <- function(df,target_col){
  
  E_list <- 1:10
  theta_list <- c(0,10^seq(-2,1,by=.075))
  
  lib <- paste(1,NROW(df_BGC))
  pred <- paste(1,NROW(df_BGC))
  
  ## Simplex
  stats_simplex <- map_df(E_list,function(E_i){
    out_simplex_i <- Simplex(dataFrame=df,
                             target=target_col,
                             columns=target_col,
                             lib=lib,pred=pred,
                             E=E_i)
    
    stats_i <- ComputeError(out_simplex_i$Predictions,out_simplex_i$Observations)
    
    stats_i <- bind_cols(data.frame(n=sum(complete.cases(out_simplex_i)),
                         E=E_i),
              stats_i
              )
    
    return(stats_i)
    
  })
  
  E_star <- stats_simplex$E[which.max(stats_simplex$rho)]
  
  ## S-map
  stats_smap <- map_df(theta_list,function(theta_i){
    
    out_smap_i <- SMap(dataFrame=df,
                          target=target_col,
                          columns=target_col,
                          lib=lib,pred=pred,
                          E=E_star,
                          theta=theta_i)
    
    stats_i <- ComputeError(out_smap_i$predictions$Predictions,out_smap_i$predictions$Observations)
    
    stats_i <- bind_cols(data.frame(n=sum(complete.cases(out_smap_i$predictions)),
                         E=E_star,theta=theta_i),
              stats_i
              )
    
    return(stats_i)
    
  })
  
  return(list(simplex=stats_simplex,smap=stats_smap))
  
}
```



### Null Hypothesis 1

```{r}
do_shuffle_surrogates <- function(df,target_col,n_surr=500){
  
  df_surr <- SurrogateData(df %>% pull(!!target_col),method="random_shuffle",num_surr=n_surr)
  
  map_df(1:n_surr,function(i_surr){
    
    df_i <- cbind(df[,1],data.frame(surr=df_surr[,i_surr]))
    out <- do_univariate_1_var(df_i,target_col="surr")
    
    rho_simplex <- max(out$simplex$rho)
    E_star <- out$simplex$E[which.max(out$simplex$rho)]
    delta_rho_smap <- max(out$smap$rho) - out$smap$rho[1]
    theta_star <- out$smap$theta[which.max(out$smap$rho)]
    
    return(data.frame(
      rho_simplex=rho_simplex,
      E_star = E_star,
      rho_theta0=out$smap$rho[1],
      delta_rho_smap=delta_rho_smap,
      theta_star=theta_star
    ))
    
  })
  
}
```

```{r}
out_shuffle <- do_shuffle_surrogates(df_BGC,"Chla_sechi",n_surr = 50)
```

### Null Hypothesis 2

```{r}
do_ebi_surrogates <- function(df,target_col,n_surr=500){
  
  df_surr <- SurrogateData(df %>% pull(!!target_col),method="ebisuzaki",num_surr=n_surr)
  
  map_df(1:n_surr,function(i_surr){
    
    df_i <- cbind(df[,1],data.frame(surr=df_surr[,i_surr]))
    out <- do_univariate_1_var(df_i,target_col="surr")
    
    rho_simplex <- max(out$simplex$rho)
    E_star <- out$simplex$E[which.max(out$simplex$rho)]
    delta_rho_smap <- max(out$smap$rho) - out$smap$rho[1]
    theta_star <- out$smap$theta[which.max(out$smap$rho)]
    
    return(data.frame(
      rho_simplex=rho_simplex,
      E_star = E_star,
      rho_theta0=out$smap$rho[1],
      delta_rho_smap=delta_rho_smap,
      theta_star=theta_star
    ))
    
  })
}
```


### Null Hypothesis 3

This we will test with a seasonal surrogate method. Essentially, we ask if the EDM statistics of the real time series are significantly improved from a time series formed from the same seasonal cycle with randomized residuals-- essentially a time series that is an equivalent noisy measure of the seasonal cycle as the true time series.

In another situation, we could consider instead comparison to non-parametric predictions based solely on the phase of season. However, since we are looking at 2-3mo temporal averaging, this variable only takes on 4-6 possible values. On the other hand, this is a perhaps overconservative, since the translation of the seasonal sinusoid into a noisy nonlinear oscillation itself could be considered a sign of deterministic dynamics.

```{r}
do_seasonal_surrogates <- function(df,target_col,n_surr=500){
  
  df_surr <- SurrogateData(df %>% pull(!!target_col),method="seasonal",num_surr=n_surr,T_period = 4)
  
  map_df(1:n_surr,function(i_surr){
    
    df_i <- cbind(df[,1],data.frame(surr=df_surr[,i_surr]))
    out <- do_univariate_1_var(df_i,target_col="surr")
    
    rho_simplex <- max(out$simplex$rho)
    E_star <- out$simplex$E[which.max(out$simplex$rho)]
    delta_rho_smap <- max(out$smap$rho) - out$smap$rho[1]
    theta_star <- out$smap$theta[which.max(out$smap$rho)]
    
    return(data.frame(
      rho_simplex=rho_simplex,
      E_star = E_star,
      rho_theta0=out$smap$rho[1],
      delta_rho_smap=delta_rho_smap,
      theta_star=theta_star
    ))
    
  })
  
}
```


## EDM Analysis

### Sechi-depth


```{r}
out_univar <- do_univariate_1_var(df_BGC,"Secchi_Ave")
out_univar$simplex %>% ggplot(aes(x=E,y=rho)) + geom_line()
out_univar$smap %>% ggplot(aes(x=theta,y=rho)) + geom_line()
```

```{r}
out_ebi <- do_ebi_surrogates(df_BGC,"Secchi_Ave",n_surr = 200)
sum(out_ebi$delta_rho_smap < max(out_univar$smap$rho) - out_univar$smap$rho[1])
```

```{r}
out_seasonal <- do_seasonal_surrogates(df_BGC,"Chla_sechi",n_surr = 50)
```




